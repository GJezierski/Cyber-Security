## Practical Malware Analysis & Triage

### Basic Static Analysis

1. Hashing Malware

```
C:\Users\root\Desktop
λ sha256sum.exe Malware.Unknown.exe.malz
92730427321a1c4ccfc0d0580834daef98121efa9bb8963da332bfd6cf1fda8a *Malware.Unknown.exe.malz

C:\Users\root\Desktop
λ md5sum.exe Malware.Unknown.exe.malz
1d8562c0adcaee734d63f7baaca02f7c *Malware.Unknown.exe.malz
```

2. Malware Repositories: VirusTotal

```
92730427321a1c4ccfc0d0580834daef98121efa9bb8963da332bfd6cf1fda8a
Malware.Unknown.exe.malz
https://www.virustotal.com/gui/file/92730427321a1c4ccfc0d0580834daef98121efa9bb8963da332bfd6cf1fda8a

46 security vendors and no sandboxes flagged this file as malicious
```

3. Strings & FLOSS: Static String Analysis

```
C:\Users\root\Desktop
λ floss Malware.Unknown.exe.malz
INFO: floss: extracting static strings...
finding decoding function features: 100%|█| 67/67 [00:00<00:00, 2241.37 functions/s, skipped 26 library functions (38%) INFO: floss.stackstrings: extracting stackstrings from 20 functions
INFO: floss.results: ineIGenu
extracting stackstrings: 100%|████████████████████████████████████████████████| 20/20 [00:00<00:00, 128.05 functions/s] INFO: floss.tightstrings: extracting tightstrings from 0 functions...
extracting tightstrings: 0 functions [00:00, ? functions/s]
INFO: floss.string_decoder: decoding strings
emulating function 0x401be2 (call 1/1): 100%|██████████████████████████████████| 20/20 [00:00<00:00, 32.82 functions/s] INFO: floss: finished execution after 13.25 seconds

FLARE FLOSS RESULTS (version v2.1.0-0-gbf2bf1c)
+------------------------+------------------------------------------------------------------------------------+
| file path              | Malware.Unknown.exe.malz                                                           |
| extracted strings      |                                                                                    |
|  static strings        | 177                                                                                |
|  stack strings         | 1                                                                                  |
|  tight strings         | 0                                                                                  |
|  decoded strings       | 0                                                                                  |
+------------------------+------------------------------------------------------------------------------------+

------------------------------
| FLOSS STATIC STRINGS (177) |
------------------------------
-----------------------------
| FLOSS ASCII STRINGS (169) |
-----------------------------

------------------------------
| FLOSS UTF-16LE STRINGS (8) |
------------------------------
jjjj
cmd.exe /C ping 1.1.1.1 -n 1 -w 3000 > Nul & Del /f /q "%s"
http://ssl-6582datamanager.helpdeskbros.local/favicon.ico
C:\Users\Public\Documents\CR433101.dat.exe
Mozilla/5.0
http://huskyhacks.dev
ping 1.1.1.1 -n 1 -w 3000 > Nul & C:\Users\Public\Documents\CR433101.dat.exe
open
---------------------------
| FLOSS STACK STRINGS (1) |
---------------------------

---------------------------
| FLOSS TIGHT STRINGS (0) |
---------------------------

-----------------------------
| FLOSS DECODED STRINGS (0) |
-----------------------------
```

4. Analyzing the Import Address Table

``` PEView ```

5. Introduction to the Windows API

``` PEView ```
6. MalAPI.io

7. To Pack Or Not To Pack: Packed Malware Analysis

``` PEView ```

8. Combining Analysis Methods: PEStudio

9. Identifying Malware Capabilities & Intro to MITRE ATT&CK
```
Capa
```
```
C:\Users\root\Desktop
λ capa C:\Users\root\Desktop\Malware.Unknown.exe.malz
loading : 100%|█████████████████████████████████████████████████████████████████| 703/703 [00:00<00:00, 956.91 rules/s] matching: 100%|███████████████████████████| 67/67 [00:00<00:00, 112.77 functions/s, skipped 26 library functions (38%)] +------------------------+------------------------------------------------------------------------------------+
| md5                    | 1d8562c0adcaee734d63f7baaca02f7c                                                   |
| sha1                   | be138820e72435043b065fbf3a786be274b147ab                                           |
| sha256                 | 92730427321a1c4ccfc0d0580834daef98121efa9bb8963da332bfd6cf1fda8a                   |
| os                     | windows                                                                            |
| format                 | pe                                                                                 |
| arch                   | i386                                                                               |
| path                   | C:\Users\root\Desktop\Malware.Unknown.exe.malz                                     |
+------------------------+------------------------------------------------------------------------------------+


+-----------------------------+-------------------------------------------------------------------------------+
| MBC Objective               | MBC Behavior                                                                  |
|-----------------------------+-------------------------------------------------------------------------------|
| COMMAND AND CONTROL         | C2 Communication::Receive Data [B0030.002]                                    |
| COMMUNICATION               | HTTP Communication::Create Request [C0002.012]                                |
|                             | HTTP Communication::Download URL [C0002.006]                                  |
|                             | HTTP Communication::Open URL [C0002.004]                                      |
| PROCESS                     | Create Process [C0017]                                                        |
+-----------------------------+-------------------------------------------------------------------------------+

+------------------------------------------------------+------------------------------------------------------+
| CAPABILITY                                           | NAMESPACE                                            |
|------------------------------------------------------+------------------------------------------------------|
| receive data                                         | communication                                        |
| connect to URL                                       | communication/http/client                            |
| contains PDB path                                    | executable/pe/pdb                                    |
| contain a resource (.rsrc) section                   | executable/pe/section/rsrc                           |
| create process on Windows (2 matches)                | host-interaction/process/create                      |
+------------------------------------------------------+------------------------------------------------------+

```

```
C:\Users\root\Desktop
λ capa C:\Users\root\Desktop\Malware.Unknown.exe.malz -v
loading : 100%|████████████████████████████████████████████████████████████████| 703/703 [00:00<00:00, 1285.82 rules/s] matching: 100%|███████████████████████████| 67/67 [00:00<00:00, 137.83 functions/s, skipped 26 library functions (38%)] md5                     1d8562c0adcaee734d63f7baaca02f7c
sha1                    be138820e72435043b065fbf3a786be274b147ab
sha256                  92730427321a1c4ccfc0d0580834daef98121efa9bb8963da332bfd6cf1fda8a
path                    C:\Users\root\Desktop\Malware.Unknown.exe.malz
timestamp               2023-01-28 11:10:34.476746
capa version            v4.0.1-0-g3c41415
os                      windows
format                  pe
arch                    i386
extractor               VivisectFeatureExtractor
base address            0x400000
rules                   C:\Users\root\AppData\Local\Temp\_MEI62282\rules
function count          41
library function count  26
total feature count     993

receive data
namespace    communication
description  all known techniques for receiving data from a potential C2 server
scope        function
matches      0x401080

connect to URL
namespace  communication/http/client
scope      function
matches    0x401080

create HTTP request
namespace  communication/http/client
scope      function
matches    0x401080

download URL
namespace  communication/http/client
scope      function
matches    0x401080

contains PDB path
namespace  executable/pe/pdb
scope      file

contain a resource (.rsrc) section
namespace  executable/pe/section/rsrc
scope      file

create process on Windows (2 matches)
namespace  host-interaction/process/create
scope      basic block
matches    0x4010E3
           0x401142
```

```
C:\Users\root\Desktop
λ capa C:\Users\root\Desktop\Malware.Unknown.exe.malz -vv
loading : 100%|████████████████████████████████████████████████████████████████| 703/703 [00:00<00:00, 1284.87 rules/s] matching: 100%|███████████████████████████| 67/67 [00:00<00:00, 158.48 functions/s, skipped 26 library functions (38%)] md5                     1d8562c0adcaee734d63f7baaca02f7c
sha1                    be138820e72435043b065fbf3a786be274b147ab
sha256                  92730427321a1c4ccfc0d0580834daef98121efa9bb8963da332bfd6cf1fda8a
path                    C:\Users\root\Desktop\Malware.Unknown.exe.malz
timestamp               2023-01-28 11:12:14.116617
capa version            v4.0.1-0-g3c41415
os                      windows
format                  pe
arch                    i386
extractor               VivisectFeatureExtractor
base address            0x400000
rules                   C:\Users\root\AppData\Local\Temp\_MEI62162\rules
function count          41
library function count  26
total feature count     993

contain loop (2 matches)
namespace
author     moritz.raabe@mandiant.com
scope      function
function @ 0x4011E0
  or:
    characteristic: loop @ 0x4011E0
function @ 0x401C78
  or:
    characteristic: loop @ 0x401C78

receive data
namespace    communication
author       william.ballenthin@mandiant.com
scope        function
mbc          Command and Control::C2 Communication::Receive Data [B0030.002]
description  all known techniques for receiving data from a potential C2 server
function @ 0x401080
  or:
    match: download URL @ 0x401080
      or:
        api: urlmon.URLDownloadToFile @ 0x4010D9

connect to URL
namespace  communication/http/client
author     michael.hunhoff@mandiant.com
scope      function
mbc        Communication::HTTP Communication::Open URL [C0002.004]
function @ 0x401080
  and:
    api: wininet.InternetOpenUrl @ 0x4010F6
    optional:
      match: create HTTP request @ 0x401080
        and:
          or:
            api: wininet.InternetOpen @ 0x4010A7

create HTTP request
namespace  communication/http/client
author     michael.hunhoff@mandiant.com, anushka.virgaonkar@mandiant.com
scope      function
mbc        Communication::HTTP Communication::Create Request [C0002.012]
function @ 0x401080
  and:
    or:
      api: wininet.InternetOpen @ 0x4010A7

download URL
namespace  communication/http/client
author     matthew.williams@mandiant.com, michael.hunhoff@mandiant.com, anushka.virgaonkar@mandiant.com
scope      function
mbc        Communication::HTTP Communication::Download URL [C0002.006]
function @ 0x401080
  or:
    api: urlmon.URLDownloadToFile @ 0x4010D9

contains PDB path
namespace  executable/pe/pdb
author     moritz.raabe@mandiant.com
scope      file
regex: /:\\.*\.pdb/
  - "C:\\Users\\Matt\\source\\repos\\HuskyHacks\\PMAT-maldev\\src\\DownloadFromURL\\Release\\DownloadFromURL.pdb" @ file+0x1F1C

contain a resource (.rsrc) section
namespace  executable/pe/section/rsrc
author     moritz.raabe@mandiant.com
scope      file
section: .rsrc @ 0x405000

create process on Windows (2 matches)
namespace  host-interaction/process/create
author     moritz.raabe@mandiant.com
scope      basic block
mbc        Process::Create Process [C0017]
basic block @ 0x4010E3 in function 0x401080
  or:
    api: shell32.ShellExecute @ 0x401128
basic block @ 0x401142 in function 0x401080
  or:
    api: kernel32.CreateProcess @ 0x4011AD
```

